@startuml
title dispatchOrder Fishing Spot Flow

actor "User" as User
participant "Fishing Spot" as FishingSpot #72AFF6
participant "Fisher" as Fisher #F6C472
participant "P2P\nSwap" as P2PSwap #BEA1EC
participant "EVVM" as Evvm #72F6AA

activate User
User -> User: Sign dispatch\norder using ERC-191
User -> User: Sign payment\nusing ERC-191

User -> FishingSpot: Send payload
deactivate User

activate FishingSpot #72AFF6

FishingSpot -> Fisher: Catch payload

deactivate FishingSpot

activate Fisher #F6C472

Fisher -> Fisher: Verify payload

alt "Payload is valid"
    Fisher -> P2PSwap: Send payload
    activate P2PSwap #BEA1EC
    P2PSwap -> P2PSwap: Verify input data
    alt "Input data is valid"
        
        P2PSwap -> Evvm: Execute payment

        activate Evvm #72F6AA

        alt "Payment is valid"
            Evvm -> P2PSwap: Reward with MATE\nand give priority fee

            P2PSwap -> Evvm: Execute dispatch order\nfor Seller and Buyer (User)
            Evvm -> P2PSwap: Reward with MATE\nfor both transactions
            
            P2PSwap -> P2PSwap: Make order\nas completed

            alt "Fisher has sMate"
            P2PSwap -> Fisher: Reward with MATE\nand token\n(if user gives a priority fee)
            end 

            P2PSwap -> P2PSwap: Update P2P nonce for\nuser
            
        else "Payment is invalid"
            Evvm -> P2PSwap : revert
            deactivate Evvm
            P2PSwap -> Fisher: revert
        end
            
    else "Input data is invalid"
        P2PSwap -> Fisher: revert
        deactivate P2PSwap
    end

else "Payload is invalid"
    Fisher -> Fisher: Drop payload
    deactivate Fisher
end


@enduml