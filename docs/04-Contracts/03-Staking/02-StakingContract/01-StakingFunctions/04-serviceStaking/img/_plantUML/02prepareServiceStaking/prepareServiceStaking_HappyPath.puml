@startuml

<style>
document {
  BackGroundColor white
}
</style>

participant "Service Contract" as service
participant "Staking" as staking #FFD700
participant "EVVM" as evvm #00EE20

title prepareServiceStaking Transaction Flow\n(Happy Path - Successful Execution)

activate service
service -> staking : prepareServiceStaking(amountOfStaking)
activate staking #FFD700

staking -> staking : onlyCA modifier check
note right : SECURITY: Only contracts\ncan call this function\nEOAs are rejected

staking -> evvm : Query service balance\nbalances[service][PRINCIPAL_TOKEN]
activate evvm #00EE20
evvm --> staking : amountServiceBeforeStaking
deactivate evvm

staking -> evvm : Query staking contract balance\nbalances[address(this)][PRINCIPAL_TOKEN]
activate evvm #00EE20
evvm --> staking : amountStakingBeforeStaking
deactivate evvm

staking -> staking : Store serviceStakingData:\n{\n  service: msg.sender,\n  timestamp: block.timestamp,\n  amountOfStaking: amountOfStaking,\n  amountServiceBeforeStaking,\n  amountStakingBeforeStaking\n}
note right : CRITICAL: Metadata for\nvalidation in confirmServiceStaking\nMust be used in same tx

staking --> service : Preparation completed\nNote left : NEXT STEPS:\n1. caPay() to transfer tokens\n2. confirmServiceStaking()

deactivate staking

@enduml
