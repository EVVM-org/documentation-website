@startuml

<style>
document {
  BackGroundColor white
}
</style>

title presaleStaking() Staking Flow\n(Failed Path - Error Handling)

actor "Presale User" as user
participant "Staking" as staking #FFD700
participant "EVVM" as evvm #00EE20

user -> staking : presaleStaking(\n  user, isStaking=true, nonce,\n  signature, (···)\n)
activate staking #FFD700

staking -> staking : verifyMessageSignedForStake(···)

alt #f5b7b1 Invalid signature
    staking -x user : Revert with InvalidSignatureOnStaking
    note right : SECURITY: EIP-712\nsignature must match\nuser, amount=1, nonce
    
else #white Signature valid

    staking -> staking : checkIfStakeNonceUsed(user, nonce)
    
    alt #f5b7b1 Nonce already used
        staking -x user : Revert with StakingNonceAlreadyUsed
        note right : ANTI-REPLAY:\nEach nonce can only\nbe used once
        
    else #white Nonce available

        staking -> staking : presaleClaims(isStaking=true, user)
        
        alt #f5b7b1 allowPublicStaking.flag == true
            staking -x user : Revert with PresaleStakingDisabled
            note right : PHASE ENDED:\nPresale closed when\npublic staking opens
            
        else #white Presale period active
        
            alt #f5b7b1 userPresaleStaker[user].isAllow == false
                staking -x user : Revert with UserIsNotPresaleStaker
                note right : WHITELIST:\nOnly approved presale\nusers can stake
                
            else #white User is presale staker
            
                alt #f5b7b1 userPresaleStaker[user].stakingAmount >= 2
                    staking -x user : Revert with UserPresaleStakerLimitExceeded
                    note right : HARD LIMIT:\nMax 2 staking tokens\nper presale user
                    
                else #white Limit not exceeded
                
                    alt #f5b7b1 allowPresaleStaking.flag == false
                        staking -x user : Revert with PresaleStakingDisabled
                        
                    else #white Presale enabled
                    
                        staking -> staking : userPresaleStaker[user].stakingAmount++
                        
                        staking -> staking : stakingBaseProcess(···)
                        
                        staking -> staking : Check time lock
                        
                        alt #f5b7b1 Time lock not expired
                            staking -x user : Revert with AddressMustWaitToStakeAgain
                            
                        else #white Time lock passed
                            
                            staking -> staking : makePay(···)
                            
                            staking -> evvm : pay(···)
                            activate evvm #00EE20
                            
                            alt #f5b7b1 Payment fails
                                evvm -x staking : Revert
                                staking -x user : Payment error
                                note right : Could be:\n• Invalid signature_EVVM\n• Nonce_EVVM used\n• Insufficient balance
                                
                            else #white Payment succeeds
                                evvm --> staking : Success
                                deactivate evvm
                                
                                staking -> evvm : pointStaker(user, 0x01)
                                activate evvm #00EE20
                                deactivate evvm
                                
                                staking -> staking : Update userHistory
                                
                                staking -> staking : stakingNonce[user][nonce] = true

                                alt #white msg.sender is staker
                                    staking -> staking : makeCaPay(···)
                                    
                                    staking -> evvm : caPay(···)
                                    activate evvm #00EE20
                                    
                                    alt #f5b7b1 Reward fails
                                        evvm -x staking : Error
                                        staking -x user : Reward failed
                                    else #white Rewards sent
                                        evvm --> staking : Success
                                        deactivate evvm
                                        deactivate staking
                                    end
                                end
                            end
                        end
                    end
                end
            end
        end
    end
end

@enduml