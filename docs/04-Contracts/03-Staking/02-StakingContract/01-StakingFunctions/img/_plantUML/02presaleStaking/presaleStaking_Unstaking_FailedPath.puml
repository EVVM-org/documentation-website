@startuml

<style>
document {
  BackGroundColor white
}
</style>

title presaleStaking() Unstaking Flow\n(Failed Path - Error Handling)

actor "Presale User" as user
participant "Staking" as staking #FFD700
participant "EVVM" as evvm #00EE20

user -> staking : presaleStaking(\n  user, isStaking=false, nonce,\n  signature, (···)\n)
activate staking #FFD700

staking -> staking : verifyMessageSignedForStake(···)

alt #f5b7b1 Invalid signature
    staking -x user : Revert with InvalidSignatureOnStaking
    
else #white Signature valid

    staking -> staking : checkIfStakeNonceUsed(user, nonce)
    
    alt #f5b7b1 Nonce already used
        staking -x user : Revert with StakingNonceAlreadyUsed
        
    else #white Nonce available

        staking -> staking : presaleClaims(isStaking=false, user)
        
        alt #f5b7b1 allowPublicStaking.flag == true
            staking -x user : Revert with PresaleStakingDisabled
            
        else #white Presale period active
        
            alt #f5b7b1 userPresaleStaker[user].isAllow == false
                staking -x user : Revert with UserIsNotPresaleStaker
                
            else #white User is presale staker
            
                alt #f5b7b1 userPresaleStaker[user].stakingAmount == 0
                    staking -x user : Revert with UserPresaleStakerLimitExceeded
                    note right : ERROR: Cannot unstake\nwhen stakingAmount is 0\n(No tokens staked)
                    
                else #white User has staked tokens
                
                    alt #f5b7b1 allowPresaleStaking.flag == false
                        staking -x user : Revert with PresaleStakingDisabled
                        
                    else #white Presale enabled
                    
                        staking -> staking : userPresaleStaker[user].stakingAmount--
                        
                        staking -> staking : stakingBaseProcess(···)

                        alt #white Full unstaking attempt
                            staking -> staking : Check time lock
                            
                            alt #f5b7b1 Time lock not expired
                                staking -x user : Revert with AddressMustWaitToFullUnstake
                                note right : 21-DAY RESTRICTION:\nMust wait to fully unstake
                                
                            else #white Time lock passed
                                staking -> evvm : pointStaker(user, 0x00)
                                activate evvm #00EE20
                                deactivate evvm
                            end
                        end

                        staking -> staking : Update userHistory

                        staking -> staking : makeCaPay(···)

                        staking -> evvm : caPay(···)
                        activate evvm #00EE20
                        
                        alt #f5b7b1 Refund transfer fails
                            evvm -x staking : Error
                            staking -x user : Refund failed
                        else #white Refund succeeds
                            evvm --> staking : Success
                            deactivate evvm
                            
                            staking -> staking : stakingNonce[user][nonce] = true
                            
                            alt #white msg.sender is staker
                                staking -> staking : makeCaPay(···)
                                
                                staking -> evvm : caPay(···)
                                activate evvm #00EE20
                                
                                alt #f5b7b1 Reward fails
                                    evvm -x staking : Error
                                    staking -x user : Reward failed
                                else #white Rewards sent
                                    evvm --> staking : Success
                                    deactivate evvm
                                    deactivate staking
                                end
                            end
                        end
                    end
                end
            end
        end
    end
end

@enduml