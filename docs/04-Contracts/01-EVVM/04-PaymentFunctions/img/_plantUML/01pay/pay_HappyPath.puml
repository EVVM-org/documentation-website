@startuml

<style>
document {
  BackGroundColor white
}
</style>

actor "Fisher or User" as user 
participant "EVVM" as evvm #00EE20
participant "NameService" as mns #00CEEE

title Pay Transaction Flow\n(Happy Path - Successful Execution)

activate user
user -> evvm : pay(···)
activate evvm #00EE20

evvm -> evvm : verifyMessageSignedForPay(signature)
note right : CRITICAL: Signature includes\nall payment parameters\n+ EvvmID to prevent\ncross-chain replay attacks

alt #white executor != address(0)
    evvm -> evvm : verify if msg.sender == executor
    note right : Allows delegation:\nUser signs, but only\nspecified executor can submit
end

alt #white to_identity != ""
    evvm -> mns : verifyStrictAndGetOwnerOfIdentity(to_identity)
    mns --> evvm : return valid address
else #white to_identity == ""
    evvm -> evvm : use to_address
end

evvm -> evvm : _updateBalance(from, to, token, amount)

alt #white isAddressStaker(msg.sender)
    alt #white priorityFee > 0
        evvm -> evvm : _updateBalance(from, msg.sender, token, priorityFee)
        note right : Priority fee incentivizes\nstakers to process txs\nPaid ONLY to stakers
    end
    evvm -> evvm : _giveReward(msg.sender, 1)
    note right : Staker reward in\nPrincipal Token
end

alt #white priorityFlag == true
    evvm -> evvm : asyncUsedNonce[from][nonce] = true
    note right : Async: Custom nonce\nfor parallel execution
else #white priorityFlag == false
    evvm -> evvm : nextSyncUsedNonce[from]++
    note right : Sync: Sequential nonce\nfor ordered execution
end

evvm --> user : Transaction completed successfully

deactivate evvmdeactivate user
@enduml
