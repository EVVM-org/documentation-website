@startuml

<style>
document {
    BackGroundColor white
}
</style>

actor "Fisher or User" as executor 
participant "EVVM" as evvm #00EE20
participant "NameService" as mns #00CEEE


title Disperse Pay Transaction Flow\n(Happy Path - Successful Execution)

activate executor
executor -> evvm : dispersePay(···)
activate evvm #00EE20

evvm -> evvm : verifyMessageSignedForDispersePay()

alt #white executor != address(0)
    evvm -> evvm : verify if msg.sender == executor
end

evvm -> evvm : verify balance (amount + priorityFee)

alt #white priorityFlag == true
    evvm -> evvm : verify async nonce not used
end

evvm -> evvm : balances[from][token] -= (amount + priorityFee)
note right : IMPORTANT: Balance deducted\nUPFRONT to prevent\nre-entrancy attacks

evvm -> evvm : acomulatedAmount = 0

== Begin For Loop ==

evvm -> evvm : acomulatedAmount += toData[i].amount

alt #white toData[i].to_identity != ""
    evvm -> mns : strictVerifyIfIdentityExist(to_identity)
    mns --> evvm : return true
    evvm -> mns : getOwnerOfIdentity(to_identity)
    mns --> evvm : return owner address
else #white toData[i].to_identity == ""
    evvm -> evvm : use toData[i].to_address
end

evvm -> evvm : balances[to_aux][token] += toData[i].amount

== End For Loop ==

evvm -> evvm : verify acomulatedAmount == amount
note right : CRITICAL: Sum of individual\namounts must equal total\nPrevents over/under payment


alt #white isAddressStaker(msg.sender)
    evvm -> evvm : _giveReward(msg.sender, 1)
    evvm -> evvm : balances[msg.sender][token] += priorityFee
    note right : Staker keeps priority fee

else #white not a staker
    evvm -> evvm : balances[from][token] += priorityFee
    note right : Priority fee refunded\nif not processed by staker

end

alt #white priorityFlag == true
    evvm -> evvm : asyncUsedNonce[from][nonce] = true
else #white priorityFlag == false
    evvm -> evvm : nextSyncUsedNonce[from]++
end

evvm --> executor : Transaction completed successfully

deactivate executor
deactivate evvm

@enduml
