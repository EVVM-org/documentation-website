@startuml

<style>
document {
  BackGroundColor white
}
</style>

actor "User or Service" as user
participant "NameService" as nameService #00CEEE
participant "EVVM" as evvm #00EE20

title acceptOffer Transaction Flow\n(Failed Path - Error Handling)

user -> nameService : acceptOffer(···)

activate nameService #00CEEE

nameService -> nameService : onlyOwnerOfIdentity(user, username)

alt #f5b7b1 User is not the owner of the username
    nameService -x user : Revert with\nOwnershipVerificationFailed
    note right : Only the current username\nowner can accept offers
    
else #white User owns the username

    nameService -> nameService : verifyIfNonceIsAvailable(user, nonce)

    alt #f5b7b1 nameServiceNonce[user][nonce] == true
        nameService -x user : Revert with\nNonceAlreadyUsed
        
    else #white Nonce is available

        nameService -> nameService : Validate offer

        alt #f5b7b1 Offer validation fails
            nameService -x user : Revert with\nAcceptOfferVerificationFailed
            note right : Could be:\n• usernameOffers[username][offerID].offerer == address(0)\n• usernameOffers[username][offerID].expireDate < block.timestamp
            
        else #white Offer is valid

            nameService -> nameService : verifyMessageSignedForAcceptOffer(···)

            alt #f5b7b1 Signature verification fails
                nameService -x user : Revert with\nInvalidSignatureOnNameService
                note right : Invalid signature for:\n• user\n• username\n• offerID\n• nonce
                
            else #white Signature is valid

                alt #white priorityFee_EVVM > 0
                    nameService -> nameService : makePay(user, 0, priorityFee_EVVM, ···)
                    
                    alt #white priorityFlag_EVVM == true
                        nameService -> evvm : payStaker_async(···)
                        activate evvm #00EE20
                    else #white priorityFlag_EVVM == false
                        nameService -> evvm : payStaker_sync(···)
                    end
                    
                    evvm -> evvm : Verify payment inputs
                    
                    alt #f5b7b1 Priority fee payment fails
                        evvm -x user : Revert with\npayment error
                        note right : Could be:\n• Invalid EVVM nonce\n• Invalid EVVM signature
                    else #white Priority fee payment succeeds
                        evvm -> evvm : Update balances
                        evvm -> nameService : Payment processed
                        deactivate evvm
                    end
                end

                nameService -> nameService : makeCaPay(user,\nusernameOffers[username][offerID].amount)

                nameService -> evvm : caPay(user, amount)
                activate evvm #00EE20

                alt #f5b7b1 Payment to seller fails
                    evvm -x user : Revert with\ncaPay error
                    note right : Contract balance issues\nor other EVVM errors
                else #white Payment to seller succeeds
                    evvm -> evvm : Transfer amount to seller
                    evvm -> nameService : Payment completed
                    deactivate evvm

                    nameService -> nameService : Transfer ownership:\nidentityDetails[username].owner =\nusernameOffers[username][offerID].offerer

                    nameService -> nameService : Clear offer
                    
                    alt #white isAddressStaker(msg.sender)
                        nameService -> nameService : makeCaPay(msg.sender, reward)

                        nameService -> evvm : caPay(msg.sender, reward)
                        activate evvm #00EE20

                        alt #f5b7b1 Staker reward caPay fails
                            evvm -x user : Revert with\ncaPay error
                            note right : Contract balance issues\nor other EVVM errors
                        else #white Staker reward succeeds
                            evvm -> evvm : Distribute staker rewards
                            evvm -> nameService : Reward distributed
                            deactivate evvm
                        end
                        
                    end

                    nameService -> nameService : Update locked tokens:\nmateTokenLockedForWithdrawOffers -= amount + ...

                    nameService -> nameService : nameServiceNonce[user][nonce] = true

                    nameService --> user : Offer accepted successfully\nUsername ownership transferred
                end
            end
        end
    end
end

deactivate nameService

@enduml
