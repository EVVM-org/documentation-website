@startuml

<style>
document {
    BackGroundColor white
}
</style>

actor "User or Service" as user
participant "NameService" as nameService #00CEEE
participant "EVVM" as evvm #00EE20


title preRegistrationUsername Transaction Flow\n(Failed Path - Error Handling)

user -> nameService : preRegistrationUsername(···)
activate nameService #00CEEE

nameService -> nameService : verifyIfNonceIsAvailable(···)

alt #f5b7b1 nameServiceNonce[user][nonce] == true
    nameService -x user : Revert with\nNonceAlreadyUsed
    
else #white Nonce is available

    nameService -> nameService : verifyMessageSignedForPreRegistrationUsername(···)

    alt #f5b7b1 Signature verification fails
        nameService -x user : Revert with\nInvalidSignatureOnNameService
        
    else #white Signature is valid

        alt #white priorityFee_EVVM > 0
            nameService -> nameService : makePay(···)
            

            alt #white priorityFlag_EVVM == true
                nameService -> evvm : payStaker_async(···)
                activate evvm #00EE20
            else #white priorityFlag_EVVM == false
                nameService -> evvm : payStaker_sync(···)
            end
            
            
            evvm -> evvm : Verify payment inputs
            
            alt #f5b7b1 Payment verification fails
                evvm -x user : Revert with\npayment error
                note right : Could be:\n• Insufficient balance\n• Invalid nonce\n• Invalid signature
            else #white Payment succeeds
                evvm -> evvm : Update balances
                evvm -> nameService : Payment processed
                deactivate evvm
            end
            
        end

        nameService -> nameService : key = @<HashPreRegisteredUsername>

        alt #f5b7b1 identityDetails[key] already exists
            note right : Hash collision or\nalready pre-registered
            nameService -x user : Revert with\nIdentityAlreadyExists
            
        else #white Hash is available

            nameService -> nameService : set waiting period (30 minutes)

            nameService -> nameService : nameServiceNonce[user][nonce] = true

            alt #white isAddressStaker(msg.sender)
                nameService -> nameService : makeCaPay(msg.sender,\ngetRewardAmount(...) + priorityFee_EVVM)

                nameService -> evvm : caPay(···)
                activate evvm #00EE20
                
                alt #f5b7b1 caPay fails
                    evvm -x user : Revert with\ncaPay error
                    note right : Contract balance issues\nor other EVVM errors
                else #white caPay succeeds
                    evvm -> evvm : Update balances for rewards
                    evvm -> nameService : Reward distributed
                    deactivate nameService
                    deactivate evvm
                end
                
            end

        end
    end
end

deactivate nameService

@enduml
