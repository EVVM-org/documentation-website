@startuml

<style>
document {
    BackGroundColor white
}
</style>

actor "User or Service" as user
participant "NameService" as nameService #00CEEE
participant "EVVM" as evvm #00EE20

title addCustomMetadata Transaction Flow\n(Failed Path - Error Handling)

user -> nameService : addCustomMetadata(···)
activate nameService #00CEEE

nameService -> nameService : onlyOwnerOfIdentity(···)

alt #f5b7b1 User does not own the identity
    nameService -x user : Revert with\nNotOwnerOfIdentity
    
else #white User owns the identity

    nameService -> nameService : verifyAsyncNonce(user, nonce)
    note right : Reverts with AsyncNonceAlreadyUsed() if nonce already used
    
    alt #f5b7b1 nameServiceNonce[user][nonce] == true
        nameService -x user : Revert with\nNonceAlreadyUsed
        
    else #white Nonce is available

        nameService -> nameService : verify bytes(value).length > 0
        
        alt #f5b7b1 value is empty string
            nameService -x user : Revert with\nEmptyCustomMetadata
            
        else #white Value is not empty

            nameService -> nameService : verifyMessageSignedForAddCustomMetadata(···)
            
            alt #f5b7b1 Signature verification fails
                nameService -x user : Revert with\nInvalidSignatureOnNameService
                
            else #white Signature is valid

                nameService -> nameService : makePay(···, getPriceToAddCustomMetadata(), ···)

                alt #white priorityFlag_EVVM == true
                    nameService -> evvm : payStaker_async(···)
                    activate evvm #00EE20
                else #white priorityFlag_EVVM == false
                    nameService -> evvm : payStaker_sync(···)
                end
                
                evvm -> evvm : Verify payment inputs
                
                alt #f5b7b1 Payment verification fails
                    evvm -x user : Revert with\npayment error
                    note right : Could be:\n• Insufficient balance\n• Invalid EVVM nonce\n• Invalid EVVM signature
                else #white Payment succeeds
                    evvm -> evvm : Update balances
                    evvm -> nameService : Payment processed
                    deactivate evvm
                end

                alt #white isAddressStaker(msg.sender)
                    nameService -> nameService : makeCaPay(msg.sender,\n5x reward + 50% fee refund + priorityFee_EVVM)
                    
                    nameService -> evvm : caPay(···)
                    activate evvm #00EE20
                    
                    alt #f5b7b1 caPay fails
                        evvm -x user : Revert with\ncaPay error
                        note right : Contract balance issues\nor other EVVM errors
                    else #white caPay succeeds
                        evvm -> evvm : Update balances for rewards
                        evvm -> nameService : Reward distributed
                        deactivate evvm
                    end
                    
                end

                nameService -> nameService : identityCustomMetadata[identity][slot] = value

                nameService -> nameService : identityDetails[identity].customMetadataMaxSlots++

                nameService -> nameService : nameServiceNonce[user][nonce] = true

            end
        end
    end
end

deactivate nameService

@enduml

