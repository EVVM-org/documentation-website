@startuml

<style>
document {
    BackGroundColor white
}
</style>

actor "User or Service" as user
participant "NameService" as nameService #00CEEE
participant "EVVM" as evvm #00EE20

title flushCustomMetadata Transaction Flow\n(Failed Path - Error Handling)

user -> nameService : flushCustomMetadata(···)
activate nameService #00CEEE

nameService -> nameService : onlyOwnerOfIdentity(···)

alt #f5b7b1 User does not own the identity
    nameService -x user : Revert with\nNotOwnerOfIdentity
    
else #white User owns the identity

    nameService -> nameService : verifyIfNonceIsAvailable(···)
    
    alt #f5b7b1 nonce already used
    nameService -x user : Revert with AsyncNonceAlreadyUsed()
        nameService -x user : Revert with\nNonceAlreadyUsed
        
    else #white Nonce is available

        nameService -> nameService : verifyMessageSignedForFlushCustomMetadata(···)
        
        alt #f5b7b1 Signature verification fails
            nameService -x user : Revert with\nInvalidSignatureOnNameService
            
        else #white Signature is valid

            nameService -> nameService : verify customMetadataMaxSlots > 0
            
            alt #f5b7b1 customMetadataMaxSlots == 0
                nameService -x user : Revert with\nEmptyCustomMetadata
                note right : No metadata entries exist\nto flush
                
            else #white Has metadata entries

                nameService -> nameService : makePay(···, getPriceToFlushCustomMetadata(identity), ···)

                alt #white priorityFlag_EVVM == true
                    nameService -> evvm : payStaker_async(···)
                    activate evvm #00EE20
                else #white priorityFlag_EVVM == false
                    nameService -> evvm : payStaker_sync(···)
                end
                
                evvm -> evvm : Verify payment inputs
                
                alt #f5b7b1 Payment verification fails
                    evvm -x user : Revert with\npayment error
                    note right : Could be:\n• Insufficient balance\n• Invalid EVVM nonce\n• Invalid EVVM signature
                else #white Payment succeeds
                    evvm -> evvm : Update balances
                    evvm -> nameService : Payment processed
                    deactivate evvm
                end

                nameService -> nameService : makeCaPay(msg.sender,\n(5x reward * entries) + priorityFee_EVVM)
                
                nameService -> evvm : caPay(···)
                activate evvm #00EE20
                
                alt #f5b7b1 caPay fails
                    evvm -x user : Revert with\ncaPay error
                    note right : Contract balance issues\nor other EVVM errors
                else #white caPay succeeds
                    evvm -> evvm : Update balances for rewards
                    evvm -> nameService : Reward distributed
                    deactivate evvm
                    
                    nameService -> nameService : for loop: delete all metadata entries

                    nameService -> nameService : identityDetails[identity].customMetadataMaxSlots = 0

                    nameService -> nameService : markAsyncNonceAsUsed(user, nonce)

                    deactivate nameService
                end

            end
        end
    end
end

deactivate nameService

@enduml
